#!/usr/bin/env python3
"""
Use QEMU to run a bootable USB thumb drive
Copyright Â© 2021, 2022 Eli Array Minkoff
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
"""
import subprocess


def __print_copyright():
    """Print the GPL copyright statement."""
    print("usb_boot Copyright (C) 2021, 2022 Eli Array Minkoff.")
    print("This program comes with ABSOLUTELY NO WARRANTY;",
          "for details, see the LICENCE file.")
    print("This is free software,",
          "and you are welcome to redistribute it under certain conditions;",
          "for details, see the LICENCE file.\n\n")


def lsusb():
    """Call the lsusb system command, and return its output as list of lines
    """
    return subprocess.check_output(['lsusb']).decode().splitlines()


"""
lsusb outputs a list of USB devices with the following format:
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 001 Device 002: ID 239a:801e Adafruit Trinket M0
Bus 001 Device 005: ID 057e:200e Nintendo Co., Ltd Joy-Con Charging Grip
Bus 001 Device 006: ID 05ac:0202 Apple, Inc. Keyboard [ALPS]

A list of device ids can be found at http://www.linux-usb.org/usb.ids
"""

if __name__ == "__main__":
    __print_copyright()

    usb_devices = []
    for line in lsusb():
        # here, we only need the bus and device ids
        address_components = line.split(':')[0].split(' ')
        bus_id = address_components[1]
        device_id = address_components[3]
        usb_devices.append([[bus_id, device_id], line])

    # print out the devices in a numbered list, and ask for selection
    for i in range(len(usb_devices)):
        print(f'{i} | {usb_devices[i][1]}')
    selection = -1
    while selection < 0:
        try:
            selection = int(input("Enter the number of your selection: "))
            subprocess.run(['sudo', 'qemu-system-x86_64', '-m', '512',
                            '-enable-kvm', '-usb', '-device',
                            'usb-host,hostbus={},hostaddr={}'.format(
                usb_devices[selection][0][0],
                usb_devices[selection][0][1])])
        except Exception as e:
            print("An error occured: ")
            print(e)
            c = ''
            while c not in 'yn':
                c = input("Do you want to try again? (y/n): ").lower().strip()
            if c == 'y':
                selection = -1
            else:
                exit()
